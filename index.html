<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <script type="text/javascript">
      // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-43235370-1', 'wrouesnel.github.io');
      ga('send', 'pageview');
    </script>
    <title>wrouesnel_blog
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="negating information entropy">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <header class="header">
      <div class="content-wrap">
        <div class="logo">
          <h1><a href="http://localhost:8080">wrouesnel_blog</a></h1>
          <p class="description">negating information entropy</p>
        </div>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <!-- First article - render in full-->
        <article class="article intro"></article>
        <header>
          <h1 class="indexfullarticle"><a href="/articles/A%20better%20Getmail%20IDLE%20client/">A Better Getmail IDLE client</a></h1>
          <div class="date"><span>10. October 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Updates</h1>
<p>(2013-10-15) And like that I‘ve broken it again. Fixing the crash on <span class="caps">IMAP</span> disconnect actually broke IMAP disconnect handling.
The problem here is that IMAPClient’s exceptions are not documented at all, so a time-based thing like IDLE requires some guessing as to what IMAPClient will handle and what you need to&nbsp;handle. </p>
<p>As it stands, since <span class="caps">IDLE</span> clients that do nothing for 29 minutes get force disconnected by the RFC, and I&#39;ve amended my code to have IMAPClient <code>logoff()</code> explicitely before trying to run <code>_imaplogin()</code> if the <span class="caps">IDLE</span> session is interrupted AND a subsequent <code>select_folder()</code> call doesn&#39;t succeed (since it should always&nbsp;succeed.</p>
<p>This should hopefully be the last patching of the script, though the obvious point of failure is if <code>select_folder()</code> can end up in a weird state if the connection goes down entirely, in which case an additional Timer thread may be needed to force logoff() the connections every 30&nbsp;minutes.</p>
<p>(2013-10-14) So after 4 days of continuous usage I‘m happy with this script. The most important thing it does is crash properly when it encounters a bug. I’ve tweaked the Gist a few times in response (a typo meant imaplogin didn&#39;t recover gracefully) and added a call to <code>notify_mail</code> on exit which should&#39;ve been there to start&nbsp;with.</p>
<p>It‘s also becoming abundantly clear that I’m way to click-happy with publishing things to this blog, so some type of interface to show my revisions is probably in the future (a long with a style&nbsp;overhaul).</p>
<h1>Why</h1>
<p>My previous attempt at a GetMail <span class="caps">IDLE</span> client was a huge disappointment, since imaplib2 seems to be buggy for handling long-running processes. It‘s possible some magic in hard terminating the IMAP session after each IDLE termination is necessary, but it raises the question of why the idle() function in the library doesn’t immediately exit when this happens - to me that implies I could still end up with a zombie daemon that doesn&#39;t retreive any&nbsp;mail.</p>
<p>Thus a new project - this time based on the Python <code>imapclient</code> library. imapclient uses imaplib behind the scenes, and seems to enjoy a little bit more use then <code>imaplib2</code> so it seemed a good&nbsp;candidate.</p>
<h1>The&nbsp;script</h1>
<h2>Dependencies</h2>
<p>The script has a couple of dependencies, most easily installed with <code>pip</code>:</p>
<pre><code>$ pip install psutil imapclient</code></pre>
<p>Get it from <a href="https://gist.github.com/wrouesnel/6905023">a Gist here</a> - I‘m currently running it on my server, and naturally I’ll update this article based on how it performs as I&nbsp;go.</p>
<h1>Design</h1>
<p>The script implements a Unix daemon, and uses pidfiles to avoid concurrent executions. It&#39;s designed to be stuck in a crontab file to recover from&nbsp;crashes.</p>
<p>I went purist on this project since I wanted to avoid as many additional frameworks as possible and work mostly with built-in constructs - partly as just an exercise in what can be done. At the end of the day I ended up implementing a somewhat half-baked messaging system to manage all the threads based on&nbsp;Queues.</p>
<p>The main thread, being the listener for signals, creates a “manager” thread, which in turn spawns all my actual “idler”&nbsp;threads.</p>
<p>Everything talks with Queue.Queue() objects, and block on the get() method which efficiently uses <span class="caps">CPU</span>. The actual idle() function, being blocking, runs on its own thread and posts “new mail” events back to the idler thread, which then invokes&nbsp;getmail.</p>
<p>The biggest challenge was making sure exceptions were caught in all the right places - <code>imapclient</code> has no way to cleanly kill off an idle() process, so a shutdown involves causing the idle_check() call to return an&nbsp;exception.</p>
<p>I kind of hacked this together as I went - the main thing I really targeted was trying to make sure failure modes caused crashes, which is hard to do with Python-threading a lot of the time. A crashed script can be restarted, a zombie script doing nothing looks like it&#39;s correctly&nbsp;alive.</p>
<h1>Personal&nbsp;thoughts</h1>
<p>Pure Python is not the best for this sort of thing - an evented <span class="caps">IMAP</span> library would definitely be better but this way I can stick with mostly single file deployment, and I don&#39;t want to write my own IMAP client at the&nbsp;moment.</p>
<p>Of course <span class="caps">IMAP</span> is a simple enough protocol in most respects, so it&#39;s not like it would be hard but the exercise was still interesting. But if I want a new project with this, I would still like to tackle it in something like&nbsp;Haskell.</p>
</section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Getmail%20IDLE%20Client/">A GetMail IDLE daemon script</a></h2>
          <div class="date"><span>05. October 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Updates</h1>
<p>Although the script in this article works, I&#39;m having some problems with it after long-running sessions. The symptom seems to be that imaplib2 just stops processing <span class="caps">IDLE</span> session responses - it terminates and recreates them just fine, but no new mail is ever detected and thus getmail is never triggered. With 12 or so hours of usage out of the script, this seems odd as hell and probably like an imaplib2&nbsp;bug.</p>
<p>With the amount of sunk time on this, I‘m tempted to go in 1 of 2 directions: re-tool the script to simply invoke getmail’s <span class="caps">IDLE</span> functionality, and basically remove imaplib2 from the equation, or to write my own functions to read IMAP and use the IDLE&nbsp;command.</p>
<p>Currently I‘m going with option 3: turn on imaplib’s debugging to max, and see if I can spot the bug - but at the moment I can‘t really recommend this particular approach to anyone since it’s just not reliable enough - though it does somewhat belie the fact that Python really doesn&#39;t have a good <span class="caps">IMAP</span> IDLE&nbsp;library.</p>

          <p class="more"><a href="/articles/Getmail%20IDLE%20Client/">more</a></p>
        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Setting%20up%20sshttp/">Setting up sshttp</a></h2>
          <div class="date"><span>27. August 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><p>When I was travelling Europe I found some surprisingly restricted wi-fi hotspots in hotels. This was annoying because I use <span class="caps">SSH</span> to upload photos back home from my phone, but having not setup any tunneling helpers I just had to wait till I found a better&nbsp;one.</p>
<p>There are a number of solutions to <span class="caps">SSH</span> tunneling, but the main thing I wanted to do was implement something which would let me run several fallbacks at once. Enter <a href="https://github.com/stealth/sshttp">sshttp</a>.</p>
<p>sshttp is related to sslh, in the sense that they are both <span class="caps">SSH</span> connection multiplexers. The idea is that you point a web-browser at port 80, you get a web-page. You point your SSH client, and you get an SSH connection. Naive firewalls let the SSH traffic through without&nbsp;complaint.</p>
<p>The benefit of sshttp over sslh is that it uses Linux&#39;s <code>IP_TRANSPARENT</code> flag, which means that your <span class="caps">SSH</span> and HTTP logs all show proper source IPs, which is great for auditing and&nbsp;security.</p>
<p>This is a blog about how I set it up for my specific server case, the instructions I used as a guide were adapted from <a href="http://blog.stalkr.net/2012/02/sshhttps-multiplexing-with-sshttp.html">here</a>.</p>

          <p class="more"><a href="/articles/Setting%20up%20sshttp/">more</a></p>
        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Upstart%20troubles/">Upstart script not recognized</a></h2>
          <div class="date"><span>26. August 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><p>I frequently find myself writing upstart scripts which checkout ok, but for some reason don&#39;t get detected by the upstart daemon in the init directory, so when I run <code>start myscript</code> I get <code>unknown job</code> back. Some experimentation seems to indicate that the problem is I used gedit over <span class="caps">GVFS</span> SFTP to author a lot of these&nbsp;scripts.</p>
<p>For something like <code>myscript.conf</code>, I find the following fixes this&nbsp;problem:</p>
<pre><code>mv myscript.conf myscript.conf.d
mv myscript.conf.d myscript.conf</code></pre>
<p>And then hey presto, the script works&nbsp;perfectly.</p>
<p>Along the same lines, the <code>init-checkconf</code> utility isn‘t mentioned enough for upstart debugging - my last post shows I clearly didn’t know about it. Using it is&nbsp;simple:</p>
<pre><code>$ init-checkconf /etc/init/myscript.conf</code></pre>
<p>Note it needs to be run as a regular user. I&#39;m often logged in as root, so sudo&nbsp;suffices:</p>
<pre><code>$ sudo -u nobody init-checkconf /etc/init/myscript.conf</code></pre>

        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Wintersmithing/">Wintersmithing</a></h2>
          <div class="date"><span>18. August 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Wintersmith</h1>
<p>How to setup and use Wintersmith is covered pretty thoroughly elsewhere on the net, (namely the <a href="http://wintersmith.io/">wintersmith homepage</a>.</p>
<p>Instead I&#39;ll cover a few tweaks I had to do to get it running the way I wanted. To avoid being truly confusing, all the paths referenced here are relative to the site you create by running <code>wintersmith new &lt;your site dir here&gt;</code></p>

          <p class="more"><a href="/articles/Wintersmithing/">more</a></p>
        </section>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/archive.html">« Archives</a>
        </div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2013 Will Rouesnel &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>