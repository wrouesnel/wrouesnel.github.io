<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <script type="text/javascript">
      // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-43235370-1', 'wrouesnel.github.io');
      ga('send', 'pageview');
    </script>
    <title>wrouesnel_blog
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="negating information entropy">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <header class="header">
      <div class="content-wrap">
        <div class="logo">
          <h1><a href="http://localhost:8080">wrouesnel_blog</a></h1>
          <p class="description">negating information entropy</p>
        </div>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <!-- First article - render in full-->
        <article class="article intro"></article>
        <header>
          <h1 class="indexfullarticle"><a href="/articles/Migrating%20to%20Gmail/">Migrating to Gmail</a></h1>
          <div class="date"><span>12. November 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Why</h1>
<p>In a stitch of irony given my prior articles wrestling with a decent <span class="caps">IDLE</span> daemon for use with getmail, I&#39;m faced with a new problem in figuring out the best way to migrate all my existing, locally hosted email to&nbsp;Gmail.</p>
<p>This is evidently not an uncommon problem for people, presumably for largely the same reasons I‘m facing: although I like having everything locally on my own server, it only works in places where (1) I live in the same place as the server and (2) where my server won’t be double-<span class="caps">NAT</span>&#39;d so dynamic DNS can actually reach&nbsp;it.</p>
<h1>How</h1>
<p>My personal email has been hosted on a Dovecot <span class="caps">IMAP</span> server in a Maildir up till now. Our tool of choice for this migration will be the venerable <a href="http://offlineimap.org/">OfflineIMAP</a> utility, available on Debian-ish systems with <code>apt-get install offlineimap</code>.</p>
<h2>A&nbsp;Foreword</h2>
<p>I tried a lot to get this to work properly in a Maildir -&gt; Gmail configuration, and while it‘s technically possible I couldn’t seem to get the folder creation to play nicely with tags - OfflineIMAP wants to create them with a leading separate (‘/’ on Gmail) but Gmail itself doesn‘t recognize that as root tag. There doesn’t seem to be anyway around this behavior with name translation or&nbsp;anything.</p>
<p>I suspect you could work around this by uploading to a subdirectory, and then moving everything out of the subdirectory (sub-tag?) on Gmail, but didn&#39;t try&nbsp;it.</p>
<h2>Configuration&nbsp;file</h2>
<p>In your home directory (I did this on my home server since 7gb of email takes a long time to upload over <span class="caps">ADSL</span>) you need to create an <code>.offlineimaprc</code> file. For an <span class="caps">IMAP</span> -&gt; IMAP transfer, it has a structure something like&nbsp;this:</p>
<pre><code>[general]
accounts = Gmail-wrouesnel

# Gmail max attachment size - you&#39;ll get errors otherwise.
maxsize = 25000000
socktimeout = 600

[Account Gmail-wrouesnel]
# Note the ordering - Gmail is the &#39;local&#39; folder.
remoterepository = Local
localrepository = Gmail

[Repository Local]
type = IMAP
# This ensures we only do a 1-way transfer. If you want to do 2-way then you need a
# rule to exclude the Gmail [All Mail] folder.
readonly = True
remotehost = localhost
remoteuser = &lt;local user&gt;
remotepass = &lt;local password&gt;
ssl = yes
# I use SSL so this is needed - let it throw an error, then copy the hash back.
cert_fingerprint = 60571343279e7f43ee95000762f5fcd54ad24816
sep = .
subscribedonly = no

[Repository Gmail]
type = IMAP
ssl = yes
remotehost = imap.googlemail.com
remoteuser = &lt;gmail user&gt;
remotepass = &lt;gmail password&gt;
sslcacertfile = /etc/ssl/certs/ca-certificates.crt
sep = /
subscribedonly = no</code></pre>
<h2>Running</h2>
<p>Test the process first with <code>offlineimap --dry-run</code> to check that things are going to turn out roughly how you expect. Then execute <code>offlineimap</code> to start the process. I really recommend doing this in a byobu or screen session, or at least with the <code>nohup</code> utility since a connection drop will cause offlineimap to&nbsp;abort.</p>
<p>Check back on the process once every day or so to check it‘s still running - <span class="caps">OR</span> - write a shell script to re-invoke it until it succeeds (untested so I won’t propose any&nbsp;code).</p>
<h1>Personal&nbsp;thoughts</h1>
<p>This seems to be the most painless way to upload old email to Gmail. In my case, the move is prompted by a real life move where my <span class="caps">24TB</span> server won‘t be coming with me. I followed up some options for moving my email system, for example to a Docker image for $5 a month for 20gb, but at the end of the day had to face the fact that there was a perfectly capable free-alternative available and it would just be throwing money away. Everything already operates through my Gmail accounts anyway, so it’s not like there‘s a security concern there and when it comes to email you either use GPG or you’re doing nothing&nbsp;anyway.</p>
<p>It‘s worth the observation here that the same process used for the migration can also be used for a local backup, which is a system I will most definitely be using in the future. OfflineIMAP can write Maildir natively, so there’s no need to use an <span class="caps">IMAP</span> server locally for that, and helpfully solves the “what if Gmail suddenly disappears problem” (more likely from a power failure then anything else, but my email is important to&nbsp;me).</p>
</section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/A%20better%20Getmail%20IDLE%20client/">A Better Getmail IDLE client</a></h2>
          <div class="date"><span>10. October 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Updates</h1>
<p>(2013-10-15) And like that I‘ve broken it again. Fixing the crash on <span class="caps">IMAP</span> disconnect actually broke IMAP disconnect handling.
The problem here is that IMAPClient’s exceptions are not documented at all, so a time-based thing like IDLE requires some guessing as to what IMAPClient will handle and what you need to handle. This would all be fine if there was a way to get Gmail to boot my client after 30 seconds so I could test it&nbsp;easily.</p>
<p>I&#39;ve amended the code so that anytime the code would call <code>_imaplogin()</code> it explicitely dumps the IMAPClient object after trying to log it out, and recreates it. Near as I can tell this seems to be the safe way to do it, since the IMAPClient object <em>does</em> open a socket connection when created, and doesn&#39;t necessarily re-open if you simply re-issue the login&nbsp;command.</p>
<p>There&#39;s an ongoing lesson here that doing anything that needs to stay up with protocol like <span class="caps">IMAP</span> is an incredible&nbsp;pain.</p>
<p>(2013-10-14) So after 4 days of continuous usage I‘m happy with this script. The most important thing it does is crash properly when it encounters a bug. I’ve tweaked the Gist a few times in response (a typo meant imaplogin didn&#39;t recover gracefully) and added a call to <code>notify_mail</code> on exit which should&#39;ve been there to start&nbsp;with.</p>
<p>It‘s also becoming abundantly clear that I’m way to click-happy with publishing things to this blog, so some type of interface to show my revisions is probably in the future (a long with a style&nbsp;overhaul).</p>
<h1>Why</h1>
<p>My previous attempt at a GetMail <span class="caps">IDLE</span> client was a huge disappointment, since imaplib2 seems to be buggy for handling long-running processes. It‘s possible some magic in hard terminating the IMAP session after each IDLE termination is necessary, but it raises the question of why the idle() function in the library doesn’t immediately exit when this happens - to me that implies I could still end up with a zombie daemon that doesn&#39;t retreive any&nbsp;mail.</p>
<p>Thus a new project - this time based on the Python <code>imapclient</code> library. imapclient uses imaplib behind the scenes, and seems to enjoy a little bit more use then <code>imaplib2</code> so it seemed a good&nbsp;candidate.</p>
<h1>The&nbsp;script</h1>

          <p class="more"><a href="/articles/A%20better%20Getmail%20IDLE%20client/">more</a></p>
        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Getmail%20IDLE%20Client/">A GetMail IDLE daemon script</a></h2>
          <div class="date"><span>05. October 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Updates</h1>
<p>Although the script in this article works, I&#39;m having some problems with it after long-running sessions. The symptom seems to be that imaplib2 just stops processing <span class="caps">IDLE</span> session responses - it terminates and recreates them just fine, but no new mail is ever detected and thus getmail is never triggered. With 12 or so hours of usage out of the script, this seems odd as hell and probably like an imaplib2&nbsp;bug.</p>
<p>With the amount of sunk time on this, I‘m tempted to go in 1 of 2 directions: re-tool the script to simply invoke getmail’s <span class="caps">IDLE</span> functionality, and basically remove imaplib2 from the equation, or to write my own functions to read IMAP and use the IDLE&nbsp;command.</p>
<p>Currently I‘m going with option 3: turn on imaplib’s debugging to max, and see if I can spot the bug - but at the moment I can‘t really recommend this particular approach to anyone since it’s just not reliable enough - though it does somewhat belie the fact that Python really doesn&#39;t have a good <span class="caps">IMAP</span> IDLE&nbsp;library.</p>

          <p class="more"><a href="/articles/Getmail%20IDLE%20Client/">more</a></p>
        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Setting%20up%20sshttp/">Setting up sshttp</a></h2>
          <div class="date"><span>27. August 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><p>When I was travelling Europe I found some surprisingly restricted wi-fi hotspots in hotels. This was annoying because I use <span class="caps">SSH</span> to upload photos back home from my phone, but having not setup any tunneling helpers I just had to wait till I found a better&nbsp;one.</p>
<p>There are a number of solutions to <span class="caps">SSH</span> tunneling, but the main thing I wanted to do was implement something which would let me run several fallbacks at once. Enter <a href="https://github.com/stealth/sshttp">sshttp</a>.</p>
<p>sshttp is related to sslh, in the sense that they are both <span class="caps">SSH</span> connection multiplexers. The idea is that you point a web-browser at port 80, you get a web-page. You point your SSH client, and you get an SSH connection. Naive firewalls let the SSH traffic through without&nbsp;complaint.</p>
<p>The benefit of sshttp over sslh is that it uses Linux&#39;s <code>IP_TRANSPARENT</code> flag, which means that your <span class="caps">SSH</span> and HTTP logs all show proper source IPs, which is great for auditing and&nbsp;security.</p>
<p>This is a blog about how I set it up for my specific server case, the instructions I used as a guide were adapted from <a href="http://blog.stalkr.net/2012/02/sshhttps-multiplexing-with-sshttp.html">here</a>.</p>

          <p class="more"><a href="/articles/Setting%20up%20sshttp/">more</a></p>
        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Upstart%20troubles/">Upstart script not recognized</a></h2>
          <div class="date"><span>26. August 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><p>I frequently find myself writing upstart scripts which checkout ok, but for some reason don&#39;t get detected by the upstart daemon in the init directory, so when I run <code>start myscript</code> I get <code>unknown job</code> back. Some experimentation seems to indicate that the problem is I used gedit over <span class="caps">GVFS</span> SFTP to author a lot of these&nbsp;scripts.</p>
<p>For something like <code>myscript.conf</code>, I find the following fixes this&nbsp;problem:</p>
<pre><code>mv myscript.conf myscript.conf.d
mv myscript.conf.d myscript.conf</code></pre>
<p>And then hey presto, the script works&nbsp;perfectly.</p>
<p>Along the same lines, the <code>init-checkconf</code> utility isn‘t mentioned enough for upstart debugging - my last post shows I clearly didn’t know about it. Using it is&nbsp;simple:</p>
<pre><code>$ init-checkconf /etc/init/myscript.conf</code></pre>
<p>Note it needs to be run as a regular user. I&#39;m often logged in as root, so sudo&nbsp;suffices:</p>
<pre><code>$ sudo -u nobody init-checkconf /etc/init/myscript.conf</code></pre>

        </section>
        <article class="article intro"></article>
        <header>
          <h2><a href="/articles/Wintersmithing/">Wintersmithing</a></h2>
          <div class="date"><span>18. August 2013</span></div>
          <p class="author"><span class="author"><a href="mailto:w.rouesnel@gmail.com">Will Rouesnel</a></span>
          </p>
        </header>
        <section class="content"><h1>Wintersmith</h1>
<p>How to setup and use Wintersmith is covered pretty thoroughly elsewhere on the net, (namely the <a href="http://wintersmith.io/">wintersmith homepage</a>.</p>
<p>Instead I&#39;ll cover a few tweaks I had to do to get it running the way I wanted. To avoid being truly confusing, all the paths referenced here are relative to the site you create by running <code>wintersmith new &lt;your site dir here&gt;</code></p>

          <p class="more"><a href="/articles/Wintersmithing/">more</a></p>
        </section>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/archive.html">« Archives</a>
        </div>
        <section class="about">
        </section>
        <section class="copy">
          <p>&copy; 2013 Will Rouesnel &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>