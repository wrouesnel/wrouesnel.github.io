<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="negating information entropy">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>wrouesnel_blog (old posts, page 1) | wrouesnel_blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://blog.wrouesnel.com/index-1.html">
<link rel="prev" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">wrouesnel_blog</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/bup-towards-the-perfect-backup/" class="u-url">bup - towards the perfect backup</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/bup-towards-the-perfect-backup/" rel="bookmark">
            <time class="published dt-published" datetime="2014-06-22T07:45:00-10:00" itemprop="datePublished" title="2014-06-22 07:45">2014-06-22 07:45</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Since I discovered it, I've been in love with the concept behind <a href="https://github.com/bup/bup">bup</a>.</p>
<p>bup appeals to my sense of efficiency in taking backups: backups should backup
the absolute minimum amount of data so I can have the most versions, and then
that frees me to use whatever level of redundancy I deem appropriate for my
backup media.</p>
<p>But more then that, the underlying technology of bup is ripe with possibility:
the basic premise of a backup tool gives rise to the possibility of a sync tool,
a deduplicated home directory tool, distributed repositories, archives and more.</p>
<h2>how it works</h2>
<p>A more complete explanation can be found on the main GitHub repository, but
essentially bup applies rsync's rolling-checksum (literally, the same algorithm)
to determine file-differences, and then only backs up the differences - somewhat
like rsnapshot.</p>
<p>Unlike rsnapshot however, bup then applies deduplication of the chunks produced
this way using SHA1 hashes, and stores the results in the git-packfile format.</p>
<p>This is both very fast (rsnapshot, conversely, is quite slow) and very redundant
- the Git tooling is able to read and understand a bup-repository as just a
Git repository with a specific commit structure (you can run <code>gitk -a</code> in a
<code>.bup</code> directory to inspect it).</p>
<h2>why its space efficient</h2>
<p>bup's archive and rolling-checksum format mean it is very space efficient. bup
can correctly deduplicate data that undergoes insertions, deletions, shifts
and copies. bup deduplicates across your entire backup set, meaning the same
file uploaded 50 times is only stored once - in fact it will only be transferred
across the network once.</p>
<p>For comparison I recently moved 180 gb of ZFS snapshots of the same dataset
undergoing various daily changes into a bup archive, and successfully compacted
it down to 50 gb. I suspect I could have gotten it smaller if I'd unpacked some
of the archive files that have been created in that backup set.</p>
<p>That is a dataset which is already deduplicated via copy-on-write semantics
(it was not using ZFS deduplication because you should basically never use ZFS
deduplication).</p>
<h2>why its fast</h2>
<p>Git is well known as being bad at handling large binary files - it was designed
to handle patches of source code, and makes assumptions to that effect. <code>bup</code>
steps around this problem because it only used the Git packfile and index
format to store data: where Git is slow, bup implements its own packfile writers
index readers to make looking up data in Git structures fast.</p>
<p>bup also uses some other tricks to do this: it will combine indexes into <code>midx</code>
files to speed up lookups, and builds <a href="http://en.wikipedia.org/wiki/Bloom_filter">bloom filters</a> to add data (a bloom filter is a
fast data structure based on hashes which tells you something is either
'probably in the data set' or <em>definitely</em> not).</p>
<h2>using bup for Windows backups</h2>
<p>bup is a Unix/Linux oriented tool, but in practice I've applied it most usefully
at the moment to some Windows servers.</p>
<p>Running bup under <a href="https://www.cygwin.com/">cygwin</a> on Windows, and is far superior to the built in Windows backup system for file-based backups. It's best to combine it with
the <a href="http://vscsc.sourceforge.net/">vscsc</a> tool which allows using 1-time
snapshots to save the backup and avoid inconsistent state.</p>
<p>You can see a <a href="https://gist.github.com/wrouesnel/8f0c681e4bf598176203">link to a Gist here</a> of my current favorite 
script for this type of thing - this bash script needs to be invoked from a 
scheduled task which runs a <a href="https://gist.github.com/wrouesnel/f5e5cc67d33db1cefdd4">batch file like this</a>.</p>
<p>If you want to use this script on Cygwin then you need to install the <code>mail</code>
utility for sending email, as well as rsync and bup.</p>
<p>This script is reasonably complicated but it is designed to be robust against
failures in a sensible way - and if we somehow fail running bup, to fallback to
making tar archives - giving us an opportunity to fix a broken backup set.</p>
<p>This script will work for backing up to your own remote server <em>today</em>. But, it
was developed to work around limitations which can be fixed - and which I have
fixed - and so the bup of tomorrow will not have them.</p>
<h2>towards the perfect backup</h2>
<p>The script above was developed for a client, and the rsync-first stage was
designed to ensure that the most recent backup would always be directly readable
from a Windows Samba share and not require using the command line.</p>
<p>It was also designed to work around a flaw with bup's indexing step which makes
it difficult to use with variable paths as produced by the <code>vscsc</code> tool in cygwin.
Although bup will work just fine, it will insist on trying to hash the entire
backup set every time - which is slow. This can be worked around by symlinking
the backup path in cygwin beforehand, but since we needed a readable backup
set it was as quick to use rsync in this instance.</p>
<p>But it doesn't have to be this way. I've submitted several patches
against bup which are also available in my <a href="https://github.com/wrouesnel/bup">personal development repository of bup</a> on GitHub.</p>
<p>The indexing problem is fixed via <code>index-grafts</code>: modifying the bup-index to
support representing the logical structure as it is intended to be in the bup
repository, rather then the literal disk path structure. This allows the index
to work as intended without any games on the filesystem, hashing only modified
or updated files.</p>
<p>The need for a directly accessible version of the backup is solved via a few
other patches. We can modify the bup virtual-filesystems layer to support a
dynamic view of the bup repository fairly easily, and add WebDAV support to
the bup-web command (the <code>dynamic-vfs</code> and <code>bup-webdav</code> branches).</p>
<p>With these changes, a bup repository can now be directly mounted as a Windows
mapped network drive via explorers web client, and files opened and copied
directly from the share. Any version of a backup set is then trivially 
accessible and importantly we can simply start <code>bup-web</code> as a cygwin service
and leave it running.</p>
<p>Hopefully these patches will be incorporated into mainline bup soon (they are
awaiting review).</p>
<h2>so should I use it?</h2>
<p>Even with the things I've had to fix, the answer is <em>absolutely</em>. bup is by far
the best backup tool I've encountered lately. For a basic Linux system it will
work great, for manual backups it will work great, and with a little scripting
it will work <em>great</em> for automatic backups under Windows and Linux.</p>
<p>The brave can try out the cutting-edge branch on my GitHub account to test out
the fixes in this blog-post, and if you do then posting about them to
[bup-list@googlegroups.com[(https://groups.google.com/forum/#!forum/bup-list) with any problems or successes or code reviews would
help a lot.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/flashing-marlin-with-eclipse-and-avrdude/" class="u-url">Flashing Marlin with Eclipse and AVR Dude</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/flashing-marlin-with-eclipse-and-avrdude/" rel="bookmark">
            <time class="published dt-published" datetime="2014-04-23T06:00:00-10:00" itemprop="datePublished" title="2014-04-23 06:00">2014-04-23 06:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Intro</h2>
<p>3D printing is still very much in the hobbyist stage, and I am a tinkerer at heart. So flashing my printer's firmware is a basic operation - in fact it has to be a basic operation, since most configuration changes are baked into the firmware.</p>
<p>But, I run my printer at 250000 baud rate over USB. This is an excellent choice for printing since the error rate from the serial line on the Arduino is basically 0, and it's faster to boot. Excellent for rapid G-code sending.</p>
<p>But it can make reprogramming using the standard Arduino IDE a bit of a pain, and by and large I don't like the standard Arduino IDE.</p>
<p>The problem is that your Arduino in 3D printing mode is running at a non-standard baudrate. Linux can handle this just fine, as can the underlying programming tool of Arduino <code>avrdude</code>, but the IDE doesn't let you just type in what you need. Eclipse does. Get the latest version of AVRdude you can, since it makes things <em>a lot</em> easier - I have 6.0.1 which is built into Ubuntu "Trusty Tahr".</p>
<h2>Reprogramming with Eclipse</h2>
<p>People have covered setting up Eclipse for Arduino elsewhere, and I will in the future cover my setup in my own words (I believe understanding comes from finding an idea explained in the right voice a lot of the time) but for now I'll just say it works pretty well.</p>
<h2>Reprogramming an Arduino Mega 2560 (or compatible)</h2>
<p>The basic command line you need for the Arduino Mega when it's running at 250000 bps is very simple. The avrdude command should be <code>avrdude -cstk500v2 -P/dev/ttyACM0 -b250000</code> in Eclipse. You can enter this by typing in the baud rate directly in the drop down box - Eclipse will accept it just fine.</p>
<p>The AVRdude settings screen should look something like this when you're done:</p>
<p><img alt="AVRDude Configuration Screen" src="posts/flashing-marlin-with-eclipse-and-avrdude/images/eclipse-avrdude-screen.png"></p>
<p>The benefit of this configuration is your printer (or arduino for another project) can be easily reflashed without having to time-out resetting it so you can run AVRdude at one of the "standard" baudrates.</p>
<p>It's worth noting that by creating a custom <code>boards.txt</code> configuration it might be possible to accomplish this in the Arduino IDE as well, but Eclipse is a much easier to use dev-environment for big Arduino projects (like 3D printer firmwares) that I don't really have any inclination to avoid it in the future (plus is generalizes out to non-Arduino AVR programming nicely).</p>
<h2>Going further</h2>
<p>This is just a short "I did this a few minutes ago note". In the future I'll detail my Arduino Eclipse workspace, to add to the signal to noise ratio on that subject.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/uninstalling-r8168-dkms/" class="u-url">Quick note - uninstalling r8618-dkms</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/uninstalling-r8168-dkms/" rel="bookmark">
            <time class="published dt-published" datetime="2014-01-30T11:06:00-11:00" itemprop="datePublished" title="2014-01-30 11:06">2014-01-30 11:06</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>This is a quick note on something I encountered while trying to work out why my Realtek NICs are so finicky about connecting and staying connected at gigabit speeds when running Linux.</p>
<p>The current hypothesis is that the <code>r8168</code> driver isn't helping very much. So I uninstalled it - and ran into two problems.</p>
<h3>Firstly</h3>
<p>...you need to uninstall it on Ubuntu/Debian with <code>apt-get remove --purge r8168-dkms</code> or the config files (and it's <em>all</em> config files) won't be properly removed, and the module will be left installed.</p>
<h3>Secondly</h3>
<p>...you really need to make sure you've removed all the <code>blacklist r8169</code> entries. They can be left behind if you don't purge configuration files, but I found I'd also left a few hanging around in the <code>/etc/modprobe.d</code> directory from earlier efforts. So a quick <code>fgrep r8169 *</code> would've saved me a lot of trouble and confusion as to why r8169 wasn't being automatically detected.</p>
<p>In my case it turned out I'd put a very official looking <code>blacklist-networking.conf</code> file in my modprobe.d directory. On both my machines.</p>
<h3>Something about Realtek NICs?</h3>
<p>If I find an answer I'll surely provide updates, but needless to say there's no rthyme or reason to when they do or do not work, other then they consistently don't work on kernel 3.11 with the r8168 driver it seems.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/running-gnome-tracker-on-a-server/" class="u-url">Running Gnome Tracker on a Server</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/running-gnome-tracker-on-a-server/" rel="bookmark">
            <time class="published dt-published" datetime="2014-01-25T14:40:00-11:00" itemprop="datePublished" title="2014-01-25 14:40">2014-01-25 14:40</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>In a passing comment it was suggested to me that it would be really great if the home fileserver offered some type of web-interface to find things. We've been aggregating downloaded files there for a while, and there's been attempts made at categorization but this all really falls apart when you wonder "what does 'productivity' mean? And does this go under 'Linux' or some other thing?"</p>
<p>Since lately I've been wanting to get desktop search working on my actual desktops, via Gnome's Tracker project and it's tie-in to Nautilus and Nemo (possibly the subject of a future blog), it seemed logical to run it on the fileserver as an indexer for our shared directories - and then to tie some kind of web ui to that.</p>
<p>Unfortunately, Tracker is very desktop orientated - there's no easy daemon mode for running it on a headless system out-of-the-box, but with a little tweaking you <em>can</em> make it work for you quite easily.</p>
<h2>How to</h2>
<p>On my system I keep Tracker running as it's own user under a system account. On Ubuntu you need to create this like so (using a root shell - <code>sudo -i</code>):</p>
<pre class="code literal-block"><span></span><code>$ adduser --system --shell<span class="o">=</span>/bin/false --disabled-login --home<span class="o">=</span>/var/lib/tracker tracker
$ adduser tracker root
</code></pre>

<p>Since tracker uses GSettings for it's configuration these days, you need to su into the user you just created to actually configure the directories which should be indexed. Since this is a server, you probably just have a list of them so set it somewhat like the example below. Note: you must run the dbus-launch commands in order to have a viable session bus for dconf to work with. This will also be a requirement of Tracker later on.</p>
<pre class="code literal-block"><span></span><code>$ su --shell /bin/bash
$ <span class="nb">eval</span> <span class="sb">`</span>dbus-launch --sh-syntax<span class="sb">`</span>
$ dconf write org/freedesktop/tracker/miner/files/index-recursive-directories <span class="s2">"['/path/to/my/dir/1', '/path/to/my/dir/2', '/etc/etc']"</span>
$ <span class="nb">kill</span> <span class="nv">$DBUS_SESSION_BUS_PID</span>
$ <span class="nb">exit</span>
</code></pre>

<p>Your Tracker user is now ready at this point. To start and stop the service, we use an <a href="posts/running-gnome-tracker-on-a-server/files/tracker.conf">Upstart script like the one below</a>:</p>
<pre class="code literal-block"><span></span><code>description <span class="s2">"gnome tracker system startup script"</span>
author <span class="s2">"wrouesnel"</span>

start on <span class="o">(</span>local-filesystems and net-device-up<span class="o">)</span>
stop on shutdown

respawn
respawn limit <span class="m">5</span> <span class="m">60</span>

setuid tracker

script
    chdir /var/lib/tracker
    <span class="nb">eval</span> <span class="sb">`</span>dbus-launch --sh-syntax<span class="sb">`</span>
    <span class="nb">echo</span> <span class="nv">$DBUS_SESSION_BUS_PID</span> &gt; .tracker-sessionbus.pid
    <span class="nb">echo</span> <span class="nv">$DBUS_SESSION_BUS_ADDRESS</span> &gt; .tracker-sessionbus
    /usr/lib/tracker/tracker-store
end script

post-start script
    chdir /var/lib/tracker
    <span class="k">while</span> <span class="o">[</span> ! -e .tracker-sessionbus <span class="o">]</span><span class="p">;</span> <span class="k">do</span> sleep <span class="m">1</span><span class="p">;</span> <span class="k">done</span>
    <span class="nv">DBUS_SESSION_BUS_ADDRESS</span><span class="o">=</span><span class="k">$(</span>cat .tracker-sessionbus<span class="k">)</span> /usr/lib/tracker/tracker-miner-fs <span class="p">&amp;</span>
end script

post-stop script 
    <span class="c1"># We need to kill off the DBUS session here</span>
    chdir /var/lib/tracker
    <span class="nb">kill</span> <span class="k">$(</span>cat .tracker-sessionbus.pid<span class="k">)</span>
    rm .tracker-sessionbus.pid
    rm .tracker-sessionbus
end script
</code></pre>

<p>Some things to focus on about the script: we launch and save the DBus session parameters. We'll need these to reconnect to the session to run tracker related commands. The post-stop stanza is to kill off the DBus session.</p>
<p>You do need to explicitely launch <code>tracker-miner-fs</code> in order for file indexing to work, but you don't need to kill it explicitely - it will be automatically shutdown when Upstart kills <code>tracker-store</code>.</p>
<p>Also note that since tracker runs as the user <code>tracker</code> it can only index files and directories which it is allowed to traverse, so check your permissions.</p>
<p>You can now start Tracker as your user with <code>start tracker</code>. And stop it with <code>stop tracker</code>. Simple and clean.</p>
<h2>Using this</h2>
<p>My plan for this setup is to throw together a Node.js app on my server that will forward queries to the tracker command line client - that app will be a future post when it's done.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/migrating-to-gmail/" class="u-url">Migrating to Gmail</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/migrating-to-gmail/" rel="bookmark">
            <time class="published dt-published" datetime="2013-11-12T12:29:00-11:00" itemprop="datePublished" title="2013-11-12 12:29">2013-11-12 12:29</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Why</h2>
<p>In a stitch of irony given my prior articles wrestling with a decent IDLE daemon for use with getmail, I'm faced with a new problem in figuring out the best way to migrate all my existing, locally hosted email to Gmail.</p>
<p>This is evidently not an uncommon problem for people, presumably for largely the same reasons I'm facing: although I like having everything locally on my own server, it only works in places where (1) I live in the same place as the server and (2) where my server won't be double-NAT'd so dynamic DNS can actually reach it.</p>
<h2>How</h2>
<p>My personal email has been hosted on a Dovecot IMAP server in a Maildir up till now. Our tool of choice for this migration will be the venerable <a href="http://offlineimap.org/">OfflineIMAP</a> utility, available on Debian-ish systems with <code>apt-get install offlineimap</code>.</p>
<h3>A Foreword</h3>
<p>I tried a lot to get this to work properly in a Maildir -&gt; Gmail configuration, and while it's technically possible I couldn't seem to get the folder creation to play nicely with tags - OfflineIMAP wants to create them with a leading separate ('/' on Gmail) but Gmail itself doesn't recognize that as root tag. There doesn't seem to be anyway around this behavior with name translation or anything.</p>
<p>I suspect you could work around this by uploading to a subdirectory, and then moving everything out of the subdirectory (sub-tag?) on Gmail, but didn't try it.</p>
<h3>Configuration file</h3>
<p>In your home directory (I did this on my home server since 7gb of email takes a long time to upload over ADSL) you need to create an <code>.offlineimaprc</code> file. For an IMAP -&gt; IMAP transfer, it has a structure something like this:</p>
<pre class="code literal-block"><span></span><code><span class="k">[general]</span>
<span class="na">accounts</span> <span class="o">=</span> <span class="s">Gmail-wrouesnel</span>

<span class="c1"># Gmail max attachment size - you'll get errors otherwise.</span>
<span class="na">maxsize</span> <span class="o">=</span> <span class="s">25000000</span>
<span class="na">socktimeout</span> <span class="o">=</span> <span class="s">600</span>

<span class="k">[Account Gmail-wrouesnel]</span>
<span class="c1"># Note the ordering - Gmail is the 'local' folder.</span>
<span class="na">remoterepository</span> <span class="o">=</span> <span class="s">Local</span>
<span class="na">localrepository</span> <span class="o">=</span> <span class="s">Gmail</span>

<span class="k">[Repository Local]</span>
<span class="na">type</span> <span class="o">=</span> <span class="s">IMAP</span>
<span class="c1"># This ensures we only do a 1-way transfer. If you want to do 2-way then you need a</span>
<span class="c1"># rule to exclude the Gmail [All Mail] folder.</span>
<span class="na">readonly</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">remotehost</span> <span class="o">=</span> <span class="s">localhost</span>
<span class="na">remoteuser</span> <span class="o">=</span> <span class="s">&lt;local user&gt;</span>
<span class="na">remotepass</span> <span class="o">=</span> <span class="s">&lt;local password&gt;</span>
<span class="na">ssl</span> <span class="o">=</span> <span class="s">yes</span>
<span class="c1"># I use SSL so this is needed - let it throw an error, then copy the hash back.</span>
<span class="na">cert_fingerprint</span> <span class="o">=</span> <span class="s">60571343279e7f43ee95000762f5fcd54ad24816</span>
<span class="na">sep</span> <span class="o">=</span> <span class="s">.</span>
<span class="na">subscribedonly</span> <span class="o">=</span> <span class="s">no</span>

<span class="k">[Repository Gmail]</span>
<span class="na">type</span> <span class="o">=</span> <span class="s">IMAP</span>
<span class="na">ssl</span> <span class="o">=</span> <span class="s">yes</span>
<span class="na">remotehost</span> <span class="o">=</span> <span class="s">imap.googlemail.com</span>
<span class="na">remoteuser</span> <span class="o">=</span> <span class="s">&lt;gmail user&gt;</span>
<span class="na">remotepass</span> <span class="o">=</span> <span class="s">&lt;gmail password&gt;</span>
<span class="na">sslcacertfile</span> <span class="o">=</span> <span class="s">/etc/ssl/certs/ca-certificates.crt</span>
<span class="na">sep</span> <span class="o">=</span> <span class="s">/</span>
<span class="na">subscribedonly</span> <span class="o">=</span> <span class="s">no</span>
</code></pre>

<h3>Running</h3>
<p>Test the process first with <code>offlineimap --dry-run</code> to check that things are going to turn out roughly how you expect. Then execute <code>offlineimap</code> to start the process. I really recommend doing this in a byobu or screen session, or at least with the <code>nohup</code> utility since a connection drop will cause offlineimap to abort.</p>
<p>Check back on the process once every day or so to check it's still running - OR - write a shell script to re-invoke it until it succeeds (untested so I won't propose any code).</p>
<h2>Personal thoughts</h2>
<p>This seems to be the most painless way to upload old email to Gmail. In my case, the move is prompted by a real life move where my 24TB server won't be coming with me. I followed up some options for moving my email system, for example to a Docker image for $5 a month for 20gb, but at the end of the day had to face the fact that there was a perfectly capable free-alternative available and it would just be throwing money away. Everything already operates through my Gmail accounts anyway, so it's not like there's a security concern there and when it comes to email you either use GPG or you're doing nothing anyway.</p>
<p>It's worth the observation here that the same process used for the migration can also be used for a local backup, which is a system I will most definitely be using in the future. OfflineIMAP can write Maildir natively, so there's no need to use an IMAP server locally for that, and helpfully solves the "what if Gmail suddenly disappears problem" (more likely from a power failure then anything else, but my email is important to me).</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/a-better-getmail-idle-client/" class="u-url">A Better Getmail IDLE client</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/a-better-getmail-idle-client/" rel="bookmark">
            <time class="published dt-published" datetime="2013-10-10T04:36:00-11:00" itemprop="datePublished" title="2013-10-10 04:36">2013-10-10 04:36</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Updates</h2>
<p>(2013-10-15) And like that I've broken it again. Fixing the crash on IMAP disconnect actually broke IMAP disconnect handling.
The problem here is that IMAPClient's exceptions are not documented at all, so a time-based thing like IDLE requires some guessing as to what IMAPClient will handle and what you need to handle. This would all be fine if there was a way to get Gmail to boot my client after 30 seconds so I could test it easily.</p>
<p>I've amended the code so that anytime the code would call <code>_imaplogin()</code> it explicitely dumps the IMAPClient object after trying to log it out, and recreates it. Near as I can tell this seems to be the safe way to do it, since the IMAPClient object <em>does</em> open a socket connection when created, and doesn't necessarily re-open if you simply re-issue the login command.</p>
<p>There's an ongoing lesson here that doing anything that needs to stay up with protocol like IMAP is an incredible pain.</p>
<p>(2013-10-14) So after 4 days of continuous usage I'm happy with this script. The most important thing it does is crash properly when it encounters a bug. I've tweaked the Gist a few times in response (a typo meant imaplogin didn't recover gracefully) and added a call to <code>notify_mail</code> on exit which should've been there to start with.</p>
<p>It's also becoming abundantly clear that I'm way to click-happy with publishing things to this blog, so some type of interface to show my revisions is probably in the future (a long with a style overhaul).</p>
<h2>Why</h2>
<p>My previous attempt at a GetMail IDLE client was a huge disappointment, since imaplib2 seems to be buggy for handling long-running processes. It's possible some magic in hard terminating the IMAP session after each IDLE termination is necessary, but it raises the question of why the idle() function in the library doesn't immediately exit when this happens - to me that implies I could still end up with a zombie daemon that doesn't retreive any mail.</p>
<p>Thus a new project - this time based on the Python <code>imapclient</code> library. imapclient uses imaplib behind the scenes, and seems to enjoy a little bit more use then <code>imaplib2</code> so it seemed a good candidate.</p>
<h2>The script</h2>
<h3>Dependencies</h3>
<p>The script has a couple of dependencies, most easily installed with <code>pip</code>:</p>
<pre class="code literal-block"><span></span><code>$ pip install psutil imapclient
</code></pre>

<p>Get it from <a href="https://gist.github.com/wrouesnel/6905023">a Gist here</a> - I'm currently running it on my server, and naturally I'll update this article based on how it performs as I go.</p>
<h2>Design</h2>
<p>The script implements a Unix daemon, and uses pidfiles to avoid concurrent executions. It's designed to be stuck in a crontab file to recover from crashes.</p>
<p>I went purist on this project since I wanted to avoid as many additional frameworks as possible and work mostly with built-in constructs - partly as just an exercise in what can be done. At the end of the day I ended up implementing a somewhat half-baked messaging system to manage all the threads based on Queues.</p>
<p>The main thread, being the listener for signals, creates a "manager" thread, which in turn spawns all my actual "idler" threads.</p>
<p>Everything talks with Queue.Queue() objects, and block on the get() method which efficiently uses CPU. The actual idle() function, being blocking, runs on its own thread and posts "new mail" events back to the idler thread, which then invokes getmail.</p>
<p>The biggest challenge was making sure exceptions were caught in all the right places - <code>imapclient</code> has no way to cleanly kill off an idle() process, so a shutdown involves causing the idle_check() call to return an exception.</p>
<p>I kind of hacked this together as I went - the main thing I really targeted was trying to make sure failure modes caused crashes, which is hard to do with Python-threading a lot of the time. A crashed script can be restarted, a zombie script doing nothing looks like it's correctly alive.</p>
<h2>Personal thoughts</h2>
<p>Pure Python is not the best for this sort of thing - an evented IMAP library would definitely be better but this way I can stick with mostly single file deployment, and I don't want to write my own IMAP client at the moment.</p>
<p>Of course IMAP is a simple enough protocol in most respects, so it's not like it would be hard but the exercise was still interesting. But if I want a new project with this, I would still like to tackle it in something like Haskell.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/getmail-idle-client/" class="u-url">A GetMail IDLE daemon script</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/getmail-idle-client/" rel="bookmark">
            <time class="published dt-published" datetime="2013-10-05T03:07:00-10:00" itemprop="datePublished" title="2013-10-05 03:07">2013-10-05 03:07</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Updates</h2>
<p>Although the script in this article works, I'm having some problems with it after long-running sessions. The symptom seems to be that imaplib2 just stops processing IDLE session responses - it terminates and recreates them just fine, but no new mail is ever detected and thus getmail is never triggered. With 12 or so hours of usage out of the script, this seems odd as hell and probably like an imaplib2 bug.</p>
<p>With the amount of sunk time on this, I'm tempted to go in 1 of 2 directions: re-tool the script to simply invoke getmail's IDLE functionality, and basically remove imaplib2 from the equation, or to write my own functions to read IMAP and use the IDLE command.</p>
<p>Currently I'm going with option 3: turn on imaplib's debugging to max, and see if I can spot the bug - but at the moment I can't really recommend this particular approach to anyone since it's just not reliable enough - though it does somewhat belie the fact that Python really doesn't have a good IMAP IDLE library.</p>
<h3>Updates 2</h3>
<p>After another long-running session of perfect performance, I'm once again stuck with a process that claims to start idling successfully, but seems to hang - giving no exceptions or warnings of any kind and only doing so after 8+ hours of perfect functioning. It's not a NAT issue since this is far short of the 5-day default timeout. </p>
<p>At a best guess the problem seems to be that once logged in, imaplib2 leaves the session open but dumbly just listens to the socket - which eventually dies for some reason (re-assigning IPs by my ISP maybe?) but imaplib's "reader" thread just blocks on polling rather then triggering the callback code (since the notable thing is I can see the poll commands in the log stop, the session timeout detection, but no invocation of the callback).</p>
<p>As it stands, I have to strongly recommend against using imaplib2 for any long running processes like IDLE - you simply can't deal with a library that's going to silently hang itself after a half-day or so without crashing or logging anything to indicate this happens - the only detection is when self-addressed emails don't arrive, but that's a really stupid keep-alive protocol. I'll be retooling the script to try out imapclient next but that will be a future article and a separate gist.</p>
<h2>Why</h2>
<p>This is a script which took way too long to come together in Python 2.7 using imaplib2 (<code>pip install imaplib2</code>).</p>
<p>The basic idea is to use the very reliabe GetMail4 (<code>apt-get install getmail4</code>) - which is written in Python - to poll my IMAP mail accounts when new mail arrives, rather then as I had been doing with a 1 minute cronjob (which is slightly too slow for how we use email these days, and may not be liked by some mail servers - not to mention resource intensive).</p>
<p>The big benefit here is rapid mail delivery, but the other benefit is that it solves the problem of cron causing overlapping executions of getmail which can lead to blank messages (though not message loss). Other means of solving, such as wrapping cron in a <code>flock</code> call aren't great, since if the lockfiles don't get cleaned up it will just stop working silently.</p>
<h2>Requirements</h2>
<p>Writing a reliable IDLE daemon that won't cause us to spend half a day wondering where our email is is not easy. This was an interesting Python project for me, and it's certainly not pretty or long - but I mostly spent a ton of time trying to think through as many edge cases as I could. In the end, I settled on tying the daemon itself to <code>sendmail</code> on my system, so at least if it crashes or an upstream server goes offline I'm notified, and I have a decent chance of seeing why, and the use of pid files means I can have cron failsafe re-execute every 5 minutes if it does go down.</p>
<h2>The Script</h2>
<p>I started with <a href="http://blog.timstoop.nl/2009/03/11/python-imap-idle-with-imaplib2/">the example</a> I found here but ended up modifiying it pretty heavily. That code isn't a great approach in my opinion since it overwhelms the stack size pretty quickly with multiple accounts - imaplib2 is multithreaded behind the scenes (2 threads per account), so spawning an extra thread to handle each account gives you 3 per account, 6 accounts gives you 18 threads + the overhead of forking and running GetMail in a subprocess.</p>
<p>Though when all things are considered, I didn't improve things all that much but using a single-overwatch thread to reset the IDLE call on each object is simpler to handle (although I don't present it that way IMO). But the important thing is it works.</p>
<h3>Download</h3>
<p>The script is quite long so grab it from the <a href="https://gist.github.com/wrouesnel/6829044">Gist</a>. It has a few dependencies, best installed with <code>pip</code></p>
<pre class="code literal-block"><span></span><code>$ pip install imaplib2 psutil
</code></pre>

<pre class="code literal-block"><span></span><code>$./getmail-idler.py -h
usage: getmail-idler.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-r GETMAILRC<span class="o">]</span> <span class="o">[</span>--pid-file PIDFILE<span class="o">]</span> <span class="o">[</span>--verbose<span class="o">]</span>
                        <span class="o">[</span>--daemonize<span class="o">]</span> <span class="o">[</span>--logfile LOGFILE<span class="o">]</span>

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -r GETMAILRC          getmail configuration file to use <span class="o">(</span>can specify more
                        <span class="k">then</span> once<span class="o">)</span>
  --pid-file PIDFILE, -p PIDFILE
                        pidfile to use <span class="k">for</span> process limiting
  --verbose, -v         <span class="nb">set</span> output verbosity
  --daemonize           should process daemonize?
  --logfile LOGFILE     file to redirect log output too <span class="o">(</span>useful <span class="k">for</span> daemon
                        mode<span class="o">)</span>
</code></pre>

<p>It uses a comprehensive argparse interface, the most important parameter is <code>-r</code>. This is exactly like the getmail -r command, and accepts files in the same format - though it doesn't search the same locations although it will search <code>$HOME/.getmail/</code>.</p>
<p>Currently it only handles IMAPSSL, which you should be using anyway though it should be easy to hack it to fix this I just have no incentive too at the moment.</p>
<p>Currently I use this with a cronjob set to every minute or 5 minutes - with verbose logging (<code>-vv</code>) it won't produce output until it forks into a daemon. This means if it crashes (and I've tried to make it crash reliably) cron will restart it on the next round, and it'll email a tracelog (hopefully).</p>
<p>My current crontab using this script:</p>
<pre class="code literal-block"><span></span><code>* * * * * /home/will/bin/getmail-idler.py -r config1.getmailrc -r config2.getmailrc -r config3.getmailrc -r config4.getmailrc -r config5.getmailrc --pid-file /tmp/will-getmail-idler.pid --logfile .getmail-idler.log -vv --daemonize
</code></pre>

<h2>Personal thoughts</h2>
<p>I'm pretty pleased with how this turned out (edit: see updates section at the top on how that's changed - I'm happy with the script, less happy with imaplib2) since it was a great exercise for me in learning some new things about Python. That said, compared to something like NodeJS, I feel with the write library this would've been faster in a language with great eventing support, rather then Python's weird middle-ground of "not quite parallel" threads. But, I keep coming back to the language, and the demo-code I used <a href="http://blog.timstoop.nl/2009/03/11/python-imap-idle-with-imaplib2/">here</a> was Python so it must be doing something right.</p>
<p>I'll probably keep refining this if I run into problems - though if it doesn't actually stop working, then I'll leave it alone since the whole self-hosted email thing's biggest downside is when your listener dies and you stop getting email - that's the problem I've really tried to solve here - IDLE PUSH email functionality, and highly visible notifications when something is wrong.</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/setting-up-sshttp/" class="u-url">Setting up sshttp</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/setting-up-sshttp/" rel="bookmark">
            <time class="published dt-published" datetime="2013-08-27T00:43:00-10:00" itemprop="datePublished" title="2013-08-27 00:43">2013-08-27 00:43</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>When I was travelling Europe I found some surprisingly restricted wi-fi hotspots in hotels. This was annoying because I use SSH to upload photos back home from my phone, but having not setup any tunneling helpers I just had to wait till I found a better one.</p>
<p>There are a number of solutions to SSH tunneling, but the main thing I wanted to do was implement something which would let me run several fallbacks at once. Enter <a href="https://github.com/stealth/sshttp">sshttp</a>.</p>
<p>sshttp is related to sslh, in the sense that they are both SSH connection multiplexers. The idea is that you point a web-browser at port 80, you get a web-page. You point your SSH client, and you get an SSH connection. Naive firewalls let the SSH traffic through without complaint.</p>
<p>The benefit of sshttp over sslh is that it uses Linux's <code>IP_TRANSPARENT</code> flag, which means that your SSH and HTTP logs all show proper source IPs, which is great for auditing and security.</p>
<p>This is a blog about how I set it up for my specific server case, the instructions I used as a guide were adapted from <a href="http://blog.stalkr.net/2012/02/sshhttps-multiplexing-with-sshttp.html">here</a>.</p>
<h3>Components</h3>
<p>My home server hosts a number of daemons, but namely a large number of nginx name-based virtual hosts for things on my network. I specifically <em>don't</em> want nginx trying to serve most of these pages to the web.</p>
<p>The idea is that sshttp is my first firewall punching fallback, and then I can install some sneakier options on the web-side of sshttp (topic for a future blog). I also wanted sshttp to be nicely integrated with upstart in case I wanted to add more daemons/redirects in the future.</p>
<h3>Installing sshttp</h3>
<p>There's no deb package available, so installation is from github and then I copy it manually to /usr/local/sbin:</p>
<pre class="code literal-block"><span></span><code>$ git clone https://github.com/stealth/sshttp
$ <span class="nb">cd</span> sshttp
$ make
$ sudo cp sshttpd /usr/local/sbin
</code></pre>

<h3>Upstart Script</h3>
<p>I settled on the following upstart script for sshttp (adapted from my favorite nodeJS launching script):</p>
<pre class="code literal-block"><span></span><code><span class="c1"># sshttpd launcher</span>
<span class="c1"># note: this at minimum needs an iptables configuration which allows the</span>
<span class="c1"># outside ports you're requesting through.</span>

description <span class="s2">"sshttpd server upstart script"</span>
author <span class="s2">"will rouesnel"</span>

start on <span class="o">(</span>local-filesystems and net-device-up<span class="o">)</span>
stop on shutdown

instance <span class="s2">"sshttpd - </span><span class="nv">$NAME</span><span class="s2">"</span>
expect daemon

<span class="c1">#respawn</span>
<span class="c1">#respawn limit 5 60</span>

pre-start script
    <span class="c1"># Check script exists</span>
    <span class="k">if</span> <span class="o">[</span> ! -e /etc/sshttp.d/<span class="nv">$NAME</span>.conf <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    . /etc/sshttp.d/<span class="nv">$NAME</span>.conf

    <span class="c1"># Clear up any old rules this instance may have left around from an</span>
    <span class="c1"># unclean shutdown</span>
    iptables -t mangle -D OUTPUT -p tcp --sport <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -D OUTPUT -p tcp --sport <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -D PREROUTING -p tcp --sport <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -m socket -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -D PREROUTING -p tcp --sport <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -m socket -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>

    iptables -t mangle -F sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -X sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>

    <span class="c1"># Add routing rules</span>
    <span class="k">if</span> ! ip rule show <span class="p">|</span> grep -q <span class="s2">"lookup </span><span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
        ip rule add fwmark <span class="si">${</span><span class="nv">MARK</span><span class="si">}</span> lookup <span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span>
    <span class="k">fi</span>

    <span class="k">if</span> ! ip route show table <span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span> <span class="p">|</span> grep -q <span class="s2">"default"</span><span class="p">;</span> <span class="k">then</span>
        ip route add <span class="nb">local</span> <span class="m">0</span>.0.0.0/0 dev lo table <span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span>
    <span class="k">fi</span>

    <span class="c1"># Add iptables mangle rule chain for this instance</span>
    iptables -t mangle -N sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -A sshttpd-<span class="nv">$NAME</span> -j MARK --set-mark <span class="si">${</span><span class="nv">MARK</span><span class="si">}</span>
    iptables -t mangle -A sshttpd-<span class="nv">$NAME</span> -j ACCEPT

    <span class="c1"># Add the output and prerouting rules</span>
    iptables -t mangle -A OUTPUT -p tcp --sport <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -j sshttpd-<span class="nv">$NAME</span>
    iptables -t mangle -A OUTPUT -p tcp --sport <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -j sshttpd-<span class="nv">$NAME</span>
    iptables -t mangle -A PREROUTING -p tcp --sport <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -m socket -j sshttpd-<span class="nv">$NAME</span>
    iptables -t mangle -A PREROUTING -p tcp --sport <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -m socket -j sshttpd-<span class="nv">$NAME</span>
end script

<span class="c1"># the daemon</span>
script
    . /etc/sshttp.d/<span class="nv">$NAME</span>.conf

    /usr/local/sbin/sshttpd -n <span class="m">1</span> -S <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -H <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -L<span class="si">${</span><span class="nv">LISTEN_PORT</span><span class="si">}</span> -U nobody -R /var/empty &gt;&gt; <span class="si">${</span><span class="nv">LOG_PATH</span><span class="si">}</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
end script

post-stop script
    . /etc/sshttp.d/<span class="nv">$NAME</span>.conf

    <span class="c1"># Try and leave a clean environment</span>
    iptables -t mangle -D OUTPUT -p tcp --sport <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -D OUTPUT -p tcp --sport <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -D PREROUTING -p tcp --sport <span class="si">${</span><span class="nv">SSH_PORT</span><span class="si">}</span> -m socket -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -t mangle -D PREROUTING -p tcp --sport <span class="si">${</span><span class="nv">HTTP_PORT</span><span class="si">}</span> -m socket -j sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>

    iptables -t mangle -F sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>
    iptables -X sshttpd-<span class="nv">$NAME</span> <span class="o">||</span> <span class="nb">true</span>

    <span class="c1"># Remove routing rules</span>
    <span class="k">if</span> ip rule show <span class="p">|</span> grep -q <span class="s2">"lookup </span><span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">then</span>
        ip rule del fwmark <span class="si">${</span><span class="nv">MARK</span><span class="si">}</span> lookup <span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span>
    <span class="k">fi</span>
    <span class="k">if</span> ip route show table <span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span> <span class="p">|</span> grep -q <span class="s2">"default"</span><span class="p">;</span> <span class="k">then</span>
        ip route del <span class="nb">local</span> <span class="m">0</span>.0.0.0/0 dev lo table <span class="si">${</span><span class="nv">TABLE</span><span class="si">}</span>
    <span class="k">fi</span>

    <span class="c1"># Let sysadmin know we went down for some reason.</span>
    cat <span class="si">${</span><span class="nv">LOG_PATH</span><span class="si">}</span> <span class="p">|</span> mail -s <span class="s2">"sshttpd - </span><span class="nv">$NAME</span><span class="s2"> process killed."</span> root
end script
</code></pre>

<p>This script nicely sets up and tears down the bits of iptables mangling and routing infrastructure needed for sshttp, and neatly creates chains for different sshttp instances based on configuration files. It'll only launch a single instance, so launching them all on boot is handled by this <a href="https://gist.github.com/wrouesnel/6341544">upstart script</a>.</p>
<p>To use this script, you need an /etc/sshttp.d directory:</p>
<pre class="code literal-block"><span></span><code>$ sudo mkdir /etc/sshttp.d
</code></pre>

<p>and a configuration file like the following, with a <code>*.conf</code> extension:</p>
<pre class="code literal-block"><span></span><code>$ cat /etc/sshttp.d/http.conf
<span class="nv">SSH_PORT</span><span class="o">=</span><span class="m">22022</span>
<span class="nv">HTTP_PORT</span><span class="o">=</span><span class="m">20080</span>
<span class="nv">LISTEN_PORT</span><span class="o">=</span><span class="m">20081</span>
<span class="nv">MARK</span><span class="o">=</span><span class="m">1</span>
<span class="nv">TABLE</span><span class="o">=</span><span class="m">22080</span>
<span class="nv">LOG_PATH</span><span class="o">=</span>/var/log/sshttp.log
</code></pre>

<p><code>LISTEN_PORT</code> is your sshttp port. It's 20081 because we're going to use iptables to forward port 80 to 20081 (to accomodate nginx - more on this later). <code>SSH_PORT</code> is an extra SSH port for openssh - so we have both 22 and 22022 open as SSH ports since 22022 can't be publically accessible (and we'd like 22 to be publically accessible).</p>
<p><code>HTTP_PORT</code> is the port your web-server is listening on, for the same reasons as the <code>SSH_PORT</code>. <code>MARK</code> is the connection marker the daemon looks for - it has to be unique for each one. <code>TABLE</code> is the route table used for look ups - I think. This value can be anything - I think.</p>
<p><code>LOG_PATH</code> I currently set to the same value for each host for simplicity - sshttp doesn't really log anything too useful (and one of it's features is that you don't need it's logs anyway).</p>
<h3>IP Tables configuration</h3>
<p>In addition to the sshttpd upstart scripts, some general <code>iptables</code> configuration was needed for my specific server.</p>
<p>To make configuring nGinx simpler for my local network, IP Tables is set to redirect all traffic coming into the server on the <code>ppp0</code> interface (my DSL line) on port 80 and 443, to the listen ports specified for sshttpd for each interface (so port 80 goes to port 20081 in the above).</p>
<p>This means I can happily keep setting up private internal servers on port 80 on my server withou futzing around with bind IPs, and instead can put anything I want to serve externally onto port 20080 as per the configuration file above.</p>
<p>I like <a href="http://www.fwbuilder.org/">Firewall Builder</a> at the moment for my configuration (although I'm thinking a shell script might be better practice in future).</p>
<p>The relevant IP tables lines if you were doing it manually would be something like</p>
<pre class="code literal-block"><span></span><code>iptables -t nat -A PREROUTING -i ppp0 -p tcp -m tcp -d &lt;your external ip&gt; --dport <span class="m">80</span> -j REDIRECT --to-ports <span class="m">20081</span>
</code></pre>

<p>Configuring iptables like this is covered fantastically elsewhere so I won't go into it here.</p>
<p>But with this redirect, externally port 80 now goes to sshttp, which then redirects it to either SSH or to the specific external application I want to serve over HTTP on port 20080.</p>
<h3>Conclusion</h3>
<p>At the moment with this setup I just have nginx serving 404s back on my sshttp server ports. But the real benefit is, I can turn those into secure proxy's to use with something like <a href="http://pwet.fr/man/linux/commandes/corkscrew">corkscrew</a> or <a href="http://proxytunnel.sourceforge.net/">proxytunnel</a>.</p>
<p>Or I can go further - use <a href="http://www.nocrew.org/software/httptunnel.html">httptunnel</a> to tunnel TCP over GET and POST connections (my actual intent) on the public facing HTTP ports. Or do both - each method has it's trade-offs, so we can just step down till we find one which works!</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/upstart-troubles/" class="u-url">Upstart script not recognized</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/upstart-troubles/" rel="bookmark">
            <time class="published dt-published" datetime="2013-08-26T18:49:00-10:00" itemprop="datePublished" title="2013-08-26 18:49">2013-08-26 18:49</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>I frequently find myself writing upstart scripts which checkout ok, but for some reason don't get detected by the upstart daemon in the init directory, so when I run <code>start myscript</code> I get <code>unknown job</code> back. Some experimentation seems to indicate that the problem is I used gedit over GVFS SFTP to author a lot of these scripts.</p>
<p>For something like <code>myscript.conf</code>, I find the following fixes this problem:</p>
<pre class="code literal-block"><span></span><code>mv myscript.conf myscript.conf.d
mv myscript.conf.d myscript.conf
</code></pre>

<p>And then hey presto, the script works perfectly.</p>
<p>Along the same lines, the <code>init-checkconf</code> utility isn't mentioned enough for upstart debugging - my last post shows I clearly didn't know about it. Using it is simple:</p>
<pre class="code literal-block"><span></span><code>$ init-checkconf /etc/init/myscript.conf
</code></pre>

<p>Note it needs to be run as a regular user. I'm often logged in as root, so sudo suffices:</p>
<pre class="code literal-block"><span></span><code>$ sudo -u nobody init-checkconf /etc/init/myscript.conf
</code></pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/wintersmithing/" class="u-url">Wintersmithing</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        <a href="authors/wrouesnel/">wrouesnel</a>
                    </span></p>
            <p class="dateline">
            <a href="posts/wintersmithing/" rel="bookmark">
            <time class="published dt-published" datetime="2013-08-18T02:33:00-10:00" itemprop="datePublished" title="2013-08-18 02:33">2013-08-18 02:33</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Wintersmith</h2>
<p>How to setup and use Wintersmith is covered pretty thoroughly elsewhere on the net, (namely the <a href="http://wintersmith.io/">wintersmith homepage</a>.</p>
<p>Instead I'll cover a few tweaks I had to do to get it running the way I wanted. To avoid being truly confusing, all the paths referenced here are relative to the site you create by running <code>wintersmith new &lt;your site dir here&gt;</code></p>
<h3>LiveReload plugin</h3>
<p>There's a Wintersmith LiveReload plugin available which makes previewing your site with <code>wintersmith preview</code> very easy - it's great for editing or setting up CSS.</p>
<p>Installing the LiveReload plugin on Linux Mint (which I run) can be done with <code>sudo npm install -g wintersmith-livereload</code></p>
<p>You need to then add the path to your <code>config.json</code> file under "plugins" e.g. for this blog:</p>
<pre class="code literal-block"><span></span><code><span class="p">{</span>
  <span class="s2">"locals"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"url"</span><span class="o">:</span> <span class="s2">"http://localhost:8080"</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"wrouesnel_blog"</span><span class="p">,</span>
    <span class="s2">"owner"</span><span class="o">:</span> <span class="s2">"Will Rouesnel"</span><span class="p">,</span>
    <span class="s2">"description"</span><span class="o">:</span> <span class="s2">"negating information entropy"</span>
  <span class="p">},</span>
  <span class="s2">"plugins"</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">"./plugins/paginator.coffee"</span><span class="p">,</span>
    <span class="s2">"wintersmith-stylus"</span><span class="p">,</span>
    <span class="s2">"wintersmith-livereload"</span>
  <span class="p">],</span>
  <span class="s2">"require"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"moment"</span><span class="o">:</span> <span class="s2">"moment"</span><span class="p">,</span>
    <span class="s2">"_"</span><span class="o">:</span> <span class="s2">"underscore"</span><span class="p">,</span>
    <span class="s2">"typogr"</span><span class="o">:</span> <span class="s2">"typogr"</span>
  <span class="p">},</span>
  <span class="s2">"jade"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"pretty"</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">"markdown"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"smartLists"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"smartypants"</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">"paginator"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"perPage"</span><span class="o">:</span> <span class="mf">20</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>You then want to insert the line:</p>
<pre class="code literal-block"><span></span><code><span class="o">!</span><span class="p">{</span> <span class="n">env</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">livereload</span><span class="p">()</span> <span class="p">}</span>
</code></pre>

<p>into the <code>templates/layout.jade</code> file - giving you something like the following at the top of the file</p>
<pre class="code literal-block"><span></span><code><span class="nn">!!! 5</span>
<span class="nt">block</span> vars
  <span class="p">-</span> <span class="kd">var</span> <span class="n">bodyclass</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nt">html</span>(<span class="na">lang=</span><span class="s">'en'</span>)
  <span class="nt">head</span>
    <span class="nt">block</span> head
      <span class="nt">meta</span>(<span class="na">charset=</span><span class="s">'utf-8'</span>)
      <span class="nt">meta</span>(<span class="na">http-equiv=</span><span class="s">'X-UA-Compatible'</span><span class="err">,</span> <span class="na">content=</span><span class="s">'IE=edge,chrome=1'</span>)
      <span class="nt">meta</span>(<span class="na">name=</span><span class="s">'viewport'</span><span class="err">,</span> <span class="na">content=</span><span class="s">'width=device-width'</span>)
      <span class="err">!{ </span><span class="nt">env</span><span class="nc">.helpers.livereload</span>() }
      <span class="nt">script</span>(<span class="na">type=</span><span class="s">'text/javascript'</span>).
</code></pre>

<p>I also add a script section with <a href="http://www.google.com/analytics/">Google Analytics</a> to layout.jade because I'm vain like that:</p>
<pre class="code literal-block"><span></span><code><span class="nn">!!! 5</span>
<span class="nt">block</span> vars
  <span class="p">-</span> <span class="kd">var</span> <span class="n">bodyclass</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nt">html</span>(<span class="na">lang=</span><span class="s">'en'</span>)
  <span class="nt">head</span>
    <span class="nt">block</span> head
      <span class="nt">meta</span>(<span class="na">charset=</span><span class="s">'utf-8'</span>)
      <span class="nt">meta</span>(<span class="na">http-equiv=</span><span class="s">'X-UA-Compatible'</span><span class="err">,</span> <span class="na">content=</span><span class="s">'IE=edge,chrome=1'</span>)
      <span class="nt">meta</span>(<span class="na">name=</span><span class="s">'viewport'</span><span class="err">,</span> <span class="na">content=</span><span class="s">'width=device-width'</span>)
      <span class="err">!{ </span><span class="nt">env</span><span class="nc">.helpers.livereload</span>() }
      <span class="nt">script</span>(<span class="na">type=</span><span class="s">'text/javascript'</span>).
        <span class="c">// google analytics</span>
        <span class="err">(</span><span class="nt">function</span>(<span class="na">i</span><span class="err">,</span><span class="na">s</span><span class="err">,</span><span class="na">o</span><span class="err">,</span><span class="na">g</span><span class="err">,</span><span class="na">r</span><span class="err">,</span><span class="na">a</span><span class="err">,</span><span class="na">m</span>){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        <span class="err">(</span><span class="nt">i</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="nc">.q</span><span class="p">=</span><span class="n">i</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">q</span><span class="o">||</span><span class="p">[]).</span><span class="n">push</span><span class="p">(</span><span class="n">arguments</span><span class="p">)},</span><span class="n">i</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="k">new</span> <span class="nc">Date</span><span class="p">();</span><span class="n">a</span><span class="o">=</span><span class="n">s</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
        <span class="nt">m</span><span class="p">=</span><span class="n">s</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="n">o</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span><span class="n">a</span><span class="p">.</span><span class="n">async</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">a</span><span class="p">.</span><span class="n">src</span><span class="o">=</span><span class="n">g</span><span class="p">;</span><span class="n">m</span><span class="p">.</span><span class="n">parentNode</span><span class="p">.</span><span class="n">insertBefore</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
        <span class="err">})(</span><span class="nt">window</span>,document,'script','//www.google-analytics.com/analytics.js','ga');

        <span class="nt">ga</span>(<span class="err">'</span><span class="na">create</span><span class="err">',</span> <span class="err">'</span><span class="na">UA-43235370-1</span><span class="err">',</span> <span class="err">'</span><span class="na">wrouesnel</span><span class="err">.</span><span class="na">github</span><span class="err">.</span><span class="na">io</span><span class="err">'</span>);
        <span class="nt">ga</span>(<span class="err">'</span><span class="na">send</span><span class="err">',</span> <span class="err">'</span><span class="na">pageview</span><span class="err">'</span>);
</code></pre>

<p><strong>The glitch</strong>: Running <code>wintersmith preview</code> with these changes you'll find it doesn't work when trying to browse to the main index.html page with something like "env is undefined". This is <a href="https://github.com/jnordberg/wintersmith/issues/141">a glitch in paginator which has been fixed upstream</a> but not in wintersmith@2.0.5 in npm. </p>
<p>To fix it I just copied <a href="https://github.com/jnordberg/wintersmith/commit/b959b35b9b153fb7ddbaa37533800777473b5a17.diff">the commit patch</a> manually into my local copy of <code>plugins/paginator.coffee</code> : </p>
<pre class="code literal-block"><span></span><code><span class="gh">diff --git a/examples/blog/plugins/paginator.coffee b/examples/blog/plugins/paginator.coffee</span>
<span class="gh">index b8e9032..19098d5 100644</span>
<span class="gd">--- a/examples/blog/plugins/paginator.coffee</span>
<span class="gi">+++ b/examples/blog/plugins/paginator.coffee</span>
<span class="gu">@@ -43,7 +43,7 @@ module.exports = (env, callback) -&gt;</span>
         return callback new Error "unknown paginator template '#{ options.template }'"

       # setup the template context
<span class="gd">-      ctx = {contents, @articles, @prevPage, @nextPage}</span>
<span class="gi">+      ctx = {env, contents, @articles, @prevPage, @nextPage}</span>

       # extend the template context with the enviroment locals
       env.utils.extend ctx, locals
</code></pre>

<h3>Show most recent article in the index</h3>
<p>By default Wintersmith shows short summaries of articles on your <code>index.html</code> page. I can't decide whether or not I like this behavior yet, but until I do what I wanted was to always have my index show my most recent post.</p>
<p>To do this, we take advantage of Jade's iteration and if/then functionality to modify <code>template/index.jade</code>.</p>
<p>As of this article my index.jade looks as follows:</p>
<pre class="code literal-block"><span></span><code><span class="nt">extends</span> layout

<span class="nt">block</span> content
  <span class="nt">include</span> author
  <span class="nt">each</span> article, num in articles
    <span class="nt">if</span> num === 0
      <span class="c">// First article - render in full</span>
      <span class="nt">article</span><span class="nc">.article.intro</span>
      <span class="nt">header</span>
        <span class="nt">h1</span><span class="nc">.indexfullarticle</span>
          <span class="nt">a</span>(<span class="na">href=</span><span class="nv">article</span><span class="err">.</span><span class="na">url</span>)<span class="p">=</span> <span class="n">article</span><span class="p">.</span><span class="n">title</span>
        <span class="nt">div</span><span class="nc">.date</span>
          <span class="nt">span</span><span class="p">=</span> <span class="n">moment</span><span class="p">(</span><span class="n">article</span><span class="p">.</span><span class="n">date</span><span class="p">).</span><span class="n">format</span><span class="p">(</span><span class="ss">'DD</span><span class="p">.</span> <span class="nc">MMMM</span> <span class="nc">YYYY</span><span class="err">'</span><span class="p">)</span>
        <span class="nt">p</span><span class="nc">.author</span>
            <span class="nt">mixin</span> author(article.metadata.author)
      <span class="nt">section</span><span class="nc">.content</span><span class="p">!=</span> <span class="n">typogr</span><span class="p">(</span><span class="n">article</span><span class="p">.</span><span class="n">html</span><span class="p">).</span><span class="n">typogrify</span><span class="p">()</span>
    <span class="nt">else</span>
      <span class="nt">article</span><span class="nc">.article.intro</span>
      <span class="nt">header</span>
        <span class="nt">h2</span>
          <span class="nt">a</span>(<span class="na">href=</span><span class="nv">article</span><span class="err">.</span><span class="na">url</span>)<span class="p">=</span> <span class="n">article</span><span class="p">.</span><span class="n">title</span>
        <span class="nt">div</span><span class="nc">.date</span>
          <span class="nt">span</span><span class="p">=</span> <span class="n">moment</span><span class="p">(</span><span class="n">article</span><span class="p">.</span><span class="n">date</span><span class="p">).</span><span class="n">format</span><span class="p">(</span><span class="ss">'DD</span><span class="p">.</span> <span class="nc">MMMM</span> <span class="nc">YYYY</span><span class="err">'</span><span class="p">)</span>
        <span class="nt">p</span><span class="nc">.author</span>
            <span class="nt">mixin</span> author(article.metadata.author)
      <span class="nt">section</span><span class="nc">.content</span>
        <span class="err">!{ </span><span class="nt">typogr</span>(<span class="na">article</span><span class="err">.</span><span class="na">intro</span>)<span class="nc">.typogrify</span>() }
        <span class="nt">if</span> article.hasMore
          <span class="nt">p</span><span class="nc">.more</span>
            <span class="nt">a</span>(<span class="na">href=</span><span class="nv">article</span><span class="err">.</span><span class="na">url</span>) more

<span class="nt">block</span> prepend footer
  <span class="nt">div</span><span class="nc">.nav</span>
    <span class="nt">if</span> prevPage
      <span class="nt">a</span>(<span class="na">href=</span><span class="nv">prevPage</span><span class="err">.</span><span class="na">url</span>) « Newer
    <span class="nt">else</span>
      <span class="nt">a</span>(<span class="na">href=</span><span class="s">'/archive.html'</span>) « Archives
    <span class="nt">if</span> nextPage
      <span class="nt">a</span>(<span class="na">href=</span><span class="nv">nextPage</span><span class="err">.</span><span class="na">url</span>) Next page »
</code></pre>

<p>There might be a better way to do this, but for me, for now it works. Basically Jade's iterators will provide an iteration number if you add a variable name for it (<code>num</code> in this case) - and the articles are chronological by default. So 0 is always the most recent.</p>
<p>From there I just duplicate some code fro <code>template/article.jade</code> to have it render the full article in <code>section.content</code> - which is <code>article.html</code>, rather then just the intro section - which is <code>article.intro</code>.</p>
<p>An important note here is that the default CSS selectors require some modification to get things to look right. I'm not sure I've nailed it yet, so editing those is an exercise left to the reader (or just a matter of downloading the stylesheet from this site).</p>
<h2>Deploy Makefile</h2>
<p>This site is hosted on Github pages, but they have no support for Wintersmith - so it's necessary to manually build the static content and upload that. <code>make</code> is more then capable of handling this task, and while we're at it it's a decent tool to automate housekeeping - in particular I wanted my article metadata to be automatically tagged with a date if the date field was blank.</p>
<h3>Automatic date tagging</h3>
<p>After banging my head with awk or sed one-liners (which probably can be done) I came to my senses and wrote a bash script to do this for me.</p>
<pre class="code literal-block"><span></span><code><span class="ch">#!/bin/bash</span>

find contents -name <span class="s1">'*.md'</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> markdownfile<span class="p">;</span> <span class="k">do</span>
    <span class="nv">datemeta</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$markdownfile</span> <span class="p">|</span> grep -m1 date: <span class="k">)</span>
    <span class="nv">datestamp</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$markdownfile</span> <span class="p">|</span> grep -m1 date: <span class="p">|</span> cut -d<span class="s1">' '</span> -f2<span class="k">)</span>

    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">"</span><span class="nv">$datemeta</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">"</span><span class="nv">$datestamp</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="c1"># generate a datestamp entry and replace the field with sed</span>
            <span class="nb">echo</span> <span class="s2">"Date stamping unstamped article </span><span class="nv">$markdownfile</span><span class="s2">"</span>
            <span class="nv">datestamp</span><span class="o">=</span><span class="k">$(</span>date <span class="s1">'+%Y-%m-%d %H:%M GMT%z'</span><span class="k">)</span>
            sed -i <span class="s2">"s/date:\ .*/date: </span><span class="nv">$datestamp</span><span class="s2">/"</span> <span class="s2">"</span><span class="nv">$markdownfile</span><span class="s2">"</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre>

<h3>Git Submodules</h3>
<p>Since I use Git to manage the blog, but GitHub Pages uses a git repo to represent the finished blog, it's necessary on my local machine to somehow have two repositories - one representing the Wintersmith site in source form, and one representing the GitHub Pages site after it's rendered.</p>
<p>I do this by treating the <code>build/</code> directory of my Wintersmith site as a Git submodule. Git won't checkout an empty repo, so you need to create a full repo somewhere and then push it to your normal storage (in my case my private server, but it could be somewhere else on GitHub):</p>
<pre class="code literal-block"><span></span><code>$ mkdir build
$ <span class="nb">cd</span> build
$ git init
$ git remote add origin ssh://will@myserver/~/wrouesnel.github.io~build.git
$ touch .gitignore
$ git add *
$ git commit
$ git push master
</code></pre>

<p>At this point you can delete the build/ directory you just created. It's not needed any more. Then it can be imported as a submodule to the main Wintersmith repo. We also need to add a remote for pushing output to Github:</p>
<pre class="code literal-block"><span></span><code>$ <span class="nb">cd</span> your_wintersmith_repo
$ git submodule add ssh://will@myserver/~/wrouesnel.github.io~build.git build
$ <span class="nb">cd</span> build
$ git remote add github git@github.com:wrouesnel/wrouesnel.github.io.git
</code></pre>

<p>And after all that effort your module is imported and ready to participate in the build process.</p>
<h3>Putting the makefile together</h3>
<p>The final makefile looks something like this:</p>
<pre class="code literal-block"><span></span><code><span class="c"># Makefile to deploy the blog</span>

<span class="c"># Search article markdown for "date" metadata that is unset and set it.</span>
<span class="nf">date</span><span class="o">:</span> 
    ./add-date-stamps.bsh

<span class="c"># Draft's are pushed to my private server</span>
<span class="nf">draft</span><span class="o">:</span> <span class="n">date</span>
    wintersmith build
    <span class="nb">cd</span> build<span class="p">;</span> git add *<span class="p">;</span> git commit -m <span class="s2">"draft"</span> <span class="p">;</span> <span class="se">\</span>
    git push origin

<span class="c"># Publish makes a draft, but then pushes to GitHub.</span>
<span class="nf">publish</span><span class="o">:</span> <span class="n">draft</span>
    <span class="nb">cd</span> build<span class="p">;</span> git commit -m <span class="s2">"published to github"</span><span class="p">;</span> <span class="se">\</span>
    git push github master

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">date</span> <span class="n">draft</span> <span class="n">publish</span>
</code></pre>

<p>The workflow is that I can call <code>make draft</code> which builds the site and commits the build to my private repo which just tracks draft sites elsewhere, and then <code>make publish</code> for when I want things to go live.</p>
<p>There are obviously other ways this could work - for example, I could use post-commit hooks on the server to push to Github Pages, but the idea here is that provided I can access the the wintersmith repository, everything else can be rebuilt.</p>
<h2>Personal thoughts</h2>
<p>I've been meaning to blog for sometime to have somewhere to put the things I do or random bits of knowledge I pick up so they might help someone else, but for one reason or another most blogging engines never did it for me.</p>
<p>I've never been much of a fan of managed services they lead to sprawling personal "infrastructure" - I'll be happy when my entire digital life can be backed up by just making a copy of my home directory.</p>
<p>So for blogging I've not much cared for the services out there or their focus. I don't particularly want to manage a heavyweight WordPress or other type of CMS installation on a web-server just for a personal blog, since that requires a lot of careful attention to security, patching, updates and I simply don't need the features. </p>
<p>At the same time services like <a href="posts/wintersmithing/www.tumblr.com">tumblr</a> never quite seemed <em>for</em> me - it skirts the line between microblogging and blogging and it's relationship with markdown and code didn't gel for me. A deluge of social networking features is also not what I wanted.</p>
<p>With Github pages offering free static site hosting, I initially looked at Jekyll as an SSG for putting something together. But Jekyll is written in Ruby, and at the moment I'm on a node.js kick so I really wanted something in that direction. Hence Wintersmith - simple, easy to use, and written in something that I'm inclinded to hack-on but with enough features out of the box (code highlighting in particular) to not feel onerous.</p>
<p>So far I'm really liking the static site model - it's simple, secure and easy to store, manage and keep in a nice neat git repository. Guess I'll see how it goes.</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-2.html" rel="prev">Newer posts</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:wrouesnel@wrouesnel.com">Will Rouesnel</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
